# ===== Build Stage =====
FROM oven/bun AS builder
WORKDIR /usr/src/app

# Copy dependency manifests first (for caching)
COPY package.json ./

# Install dependencies
RUN bun install --frozen-lockfile

# Copy the rest of the source
COPY . .

# Compile the app into a static binary
RUN bun run compile && ls -la server

# ===== Runtime Stage =====
FROM debian:12-slim AS runtime

# Create non-root user
RUN useradd -r -u 1001 -s /bin/false appuser

WORKDIR /app

# Copy binary from build stage
COPY --from=builder /usr/src/app/server ./server

# Ensure permissions
RUN chown appuser:appuser ./server && chmod +x ./server

RUN mkdir -p logs && chown -R appuser:appuser /app

USER appuser

EXPOSE 3000
ENTRYPOINT ["./server"]
